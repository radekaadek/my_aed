import overpass
import pandas as pd
import geopandas as gpd
import h3
import shapely
import pyproj

def get_point_data(node_name: str, area_name: str, api: overpass.API, date: str = None) -> list[dict]:
    """Get point data from Overpass API in the form of a list of dictionaries:

    Geometry, Type

    Keyword arguments:

    node_name -- name of the node to get data from
    area_name -- name of the area to get data from
    api -- overpass API object
    """
    
    query = ""
    # if date is not None: # to jeszcze nie dziala :(
    #     query += f'[date:"{date}"];'
    # else:
    #     query += ''
    query += f'''
    area["name"="{area_name}"]->.a;
    (
        node["{node_name}"](area.a);
    );
    out center;
    '''
    resp = api.get(query)
    nodes = []
    for node in resp['features']:
        x, y = node["geometry"]["coordinates"]
        node_geom = gpd.points_from_xy([x], [y])[0]
        name = node["properties"][node_name]
        nodes.append({"geometry": node_geom, "type": name})
    return nodes


def get_building_data(area_name: str, api: overpass.API, date: str = None) -> pd.DataFrame:
    """Get building data from Overpass API in the form of a pandas DataFrame:

    Building name, Geometry

    Keyword arguments:

    area_name -- name of the area to get data from
    api -- overpass API object
    date -- date of the data (default None)
    """
    query = f"""
    area["name"="{area_name}"]->.a;
    (
        way["building"](area.a);
        relation["building"](area.a);
    );
    out body;
    >;
    out geom;
    """
    r = api.get(query, responseformat="json")
    # example response:
    # {"version": 0.6, "generator": "Overpass API 0.7.61.5 4133829e", "osm3s": {"timestamp_osm_base": "2024-01-04T14:41:36Z", "timestamp_areas_base": "2024-01-04T13:15:00Z", "copyright": "The data included in this document is from www.openstreetmap.org. The data is made available under ODbL."}, "elements": [{"type": "way", "id": 231640379, "nodes": [2399831853, 2399831855, 2399831876, 2399831874, 2399831853], "tags": {"addr:housenumber": "15", "addr:place": "M\u0105koszyce", "addr:postcode": "66-431", "building": "residential", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640382, "nodes": [2399831997, 2399831993, 2399831995, 2399831999, 2399831997], "tags": {"addr:housenumber": "16", "addr:place": "M\u0105koszyce", "addr:postcode": "66-431", "building": "residential", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640384, "nodes": [2399832047, 2399832037, 2399832031, 2399832049, 2399832047], "tags": {"addr:housenumber": "17", "addr:place": "M\u0105koszyce", "addr:postcode": "66-431", "building": "residential", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640385, "nodes": [2399832265, 2399832263, 2399832268, 2399832269, 2399832265], "tags": {"addr:housenumber": "18", "addr:place": "M\u0105koszyce", "addr:postcode": "66-431", "building": "residential", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640415, "nodes": [2399832023, 2399832029, 2399832013, 2399832015, 2399832023], "tags": {"building": "manufacture", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640422, "nodes": [2399831991, 2399831987, 2399831985, 2399831989, 2399831991], "tags": {"building": "manufacture", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640449, "nodes": [2399831832, 2399831845, 2399831851, 2399831830, 2399831832], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640466, "nodes": [2399832280, 2399832276, 2399832272, 2399832274, 2399832278, 2399832280], "tags": {"building": "manufacture", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640469, "nodes": [2399831911, 2399831909, 2399831903, 2399831892, 2399831895, 2399831911], "tags": {"building": "manufacture", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640481, "nodes": [2399832011, 2399832017, 2399832007, 2399832009, 2399832001, 2399832003, 2399832011], "tags": {"building": "manufacture", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640489, "nodes": [2399832005, 2399832001, 2399832009, 2399832007, 2399832015, 2399832013, 2399832005], "tags": {"building": "manufacture", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640499, "nodes": [2399832251, 2399832250, 2399832253, 2399832255, 2399832257, 2399832261, 2399832259, 2399832248, 2399832251], "tags": {"building": "residential", "building:fireproof": "yes", "building:levels": "2", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640883, "nodes": [2399836358, 2399836362, 2399836370, 2399836360, 2399836358], "tags": {"addr:housenumber": "10", "addr:place": "M\u0105koszyce", "addr:postcode": "66-431", "building": "residential", "building:levels": "1", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640886, "nodes": [2399836298, 2399836301, 2399836300, 2399836299, 2399836298], "tags": {"addr:city": "M\u0105koszyce", "addr:housenumber": "12", "addr:postcode": "66-431", "addr:street": "Notecka", "building": "residential", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640888, "nodes": [2399836242, 2399836243, 2399836245, 2399836244, 2399836248, 2399836241, 2399836242], "tags": {"addr:city": "M\u0105koszyce", "addr:housenumber": "13", "addr:postcode": "66-431", "addr:street": "Notecka", "building": "residential", "building:levels": "1", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640893, "nodes": [2399836313, 2399836310, 2399836311, 2399836312, 2399836313], "tags": {"addr:city": "M\u0105koszyce", "addr:housenumber": "2", "addr:postcode": "66-431", "addr:street": "Notecka", "building": "residential", "building:levels": "1", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640895, "nodes": [2399836333, 2399836328, 2399836325, 2399836320, 2399836321, 2399836326, 2399836327, 2399836330, 2399836333], "tags": {"addr:city": "M\u0105koszyce", "addr:housenumber": "3", "addr:postcode": "66-431", "addr:street": "Notecka", "building": "residential", "building:levels": "1", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640898, "nodes": [2399836349, 2399836346, 2399836341, 2399836340, 2399836338, 2399836342, 2399836343, 2399836350, 2399836349], "tags": {"addr:housenumber": "8", "addr:place": "M\u0105koszyce", "addr:postcode": "66-431", "building": "residential", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640901, "nodes": [2399836331, 2399836329, 2399836332, 2399836334, 2399836331], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640903, "nodes": [2399836285, 2399836284, 2399836266, 2399836267, 2399836285], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640905, "nodes": [2399836263, 2399836264, 2399836267, 2399836266, 2399836263], "tags": {"building": "residential", "building:levels": "2", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640907, "nodes": [2399836344, 2399836339, 2399836337, 2399836345, 2399836344], "tags": {"building": "manufacture", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640909, "nodes": [2399836281, 2399836282, 2399836279, 2399836280, 2399836281], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640911, "nodes": [2399836296, 2399836295, 2399836293, 2399836294, 2399836296], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640912, "nodes": [2399836255, 2399836260, 2399836259, 2399836254, 2399836255], "tags": {"building": "service", "building:levels": "1", "building:use:pl": "Inny niemieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640914, "nodes": [2399836249, 2399836246, 2399836247, 2399836250, 2399836249], "tags": {"building": "service", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Inny niemieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640917, "nodes": [2399836336, 2399836334, 2399836332, 2399836335, 2399836336], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640920, "nodes": [2399836355, 2399836357, 2399836356, 2399836354, 2399836355], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640924, "nodes": [2399836274, 2399836271, 2399836276, 2399836277, 2399836274], "tags": {"building": "manufacture", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640928, "nodes": [2399836368, 2399836373, 2399836372, 2399836367, 2399836368], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640930, "nodes": [2399836378, 2399836380, 2399836381, 2399836379, 2399836378], "tags": {"building": "ruins", "building:use:pl": "Ruina", "description:pl": "Budynek w ruinie", "historic": "ruins", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640932, "nodes": [2399836257, 2399836252, 2399836253, 2399836258, 2399836257], "tags": {"building": "yes", "building:fireproof": "yes", "building:type:pl": "Przyziemie budynku ognioodpornego", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640934, "nodes": [2399836351, 2399836347, 2399836348, 2399836352, 2399836351], "tags": {"building": "manufacture", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640936, "nodes": [2399836260, 2399836255, 2399836256, 2399836261, 2399836260], "tags": {"building": "service", "building:levels": "1", "building:use:pl": "Inny niemieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640938, "nodes": [2399836314, 2399836316, 2399836317, 2399836315, 2399836314], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640944, "nodes": [2399836324, 2399836323, 2399836319, 2399836318, 2399836324], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640946, "nodes": [2399836302, 2399836303, 2399836307, 2399836306, 2399836302], "tags": {"building": "manufacture", "building:fireproof": "yes", "building:levels": "1", "building:type:pl": "Przyziemie budynku ognioodpornego", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640948, "nodes": [2399836309, 2399836308, 2399836304, 2399836305, 2399836309], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640951, "nodes": [2399836290, 2399836288, 2399836287, 2399836291, 2399836290], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640952, "nodes": [2399836374, 2399836375, 2399836377, 2399836376, 2399836374], "tags": {"building": "residential", "building:levels": "1", "building:use:pl": "Mieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640953, "nodes": [2399836261, 2399836256, 2399836251, 2399836262, 2399836261], "tags": {"building": "service", "building:levels": "1", "building:use:pl": "Inny niemieszkalny", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640955, "nodes": [2399836269, 2399836273, 2399836272, 2399836270, 2399836269], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640957, "nodes": [2399836373, 2399836368, 2399836364, 2399836365, 2399836369, 2399836373], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640958, "nodes": [2399836323, 2399836324, 2399836329, 2399836331, 2399836322, 2399836323], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640962, "nodes": [2399836363, 2399836367, 2399836372, 2399836371, 2399836366, 2399836363], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640963, "nodes": [2399836270, 2399836275, 2399836268, 2399836265, 2399836269, 2399836270], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640964, "nodes": [2399836353, 2399836359, 2399836361, 2399836357, 2399836355, 2399836353], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640966, "nodes": [2399836289, 2399836286, 2399836282, 2399836281, 2399836287, 2399836288, 2399836289], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640967, "nodes": [2399836291, 2399836294, 2399836293, 2399836297, 2399836292, 2399836290, 2399836291], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 231640970, "nodes": [2399836283, 2399836278, 2399836272, 2399836273, 2399836280, 2399836279, 2399836283], "tags": {"building": "manufacture", "building:levels": "1", "building:use:pl": "Produkcyjny, us\u0142ugowy lub gospodarczy dla rolnictwa", "source": "PODGIK Gorz\u00f3w"}}, {"type": "way", "id": 1109988146, "nodes": [10154564747, 10154564706, 10154564705, 10154564750, 10154564747], "tags": {"building": "outbuilding", "building:levels": "1", "source": "www.geoportal.gov.pl"}}, {"type": "way", "id": 1109988157, "nodes": [10154564750, 10154564749, 10154564748, 10154564747, 10154564750], "tags": {"building": "outbuilding", "building:levels": "1", "source": "www.geoportal.gov.pl"}}, {"type": "node", "id": 2399831830, "lat": 52.7385654, "lon": 15.5566473}, {"type": "node", "id": 2399831832, "lat": 52.7385467, "lon": 15.5568937}, {"type": "node", "id": 2399831845, "lat": 52.7386226, "lon": 15.556909}, {"type": "node", "id": 2399831851, "lat": 52.7386416, "lon": 15.5566653}, {"type": "node", "id": 2399831853, "lat": 52.738647, "lon": 15.5570296}, {"type": "node", "id": 2399831855, "lat": 52.7386339, "lon": 15.5571483}, {"type": "node", "id": 2399831874, "lat": 52.738786, "lon": 15.5570605}, {"type": "node", "id": 2399831876, "lat": 52.7387765, "lon": 15.5571792}, {"type": "node", "id": 2399831892, "lat": 52.738818, "lon": 15.5569446}, {"type": "node", "id": 2399831895, "lat": 52.7388092, "lon": 15.5570533}, {"type": "node", "id": 2399831903, "lat": 52.7388236, "lon": 15.5568756}, {"type": "node", "id": 2399831909, "lat": 52.7388726, "lon": 15.5568853}, {"type": "node", "id": 2399831911, "lat": 52.7388583, "lon": 15.5570644}, {"type": "node", "id": 2399831985, "lat": 52.7413182, "lon": 15.5577527}, {"type": "node", "id": 2399831987, "lat": 52.7413354, "lon": 15.55753}, {"type": "node", "id": 2399831989, "lat": 52.7413694, "lon": 15.5577638}, {"type": "node", "id": 2399831991, "lat": 52.7413861, "lon": 15.5575418}, {"type": "node", "id": 2399831993, "lat": 52.7414746, "lon": 15.557593}, {"type": "node", "id": 2399831995, "lat": 52.7414616, "lon": 15.5577848}, {"type": "node", "id": 2399831997, "lat": 52.7415344, "lon": 15.5576045}, {"type": "node", "id": 2399831999, "lat": 52.7415217, "lon": 15.5577963}, {"type": "node", "id": 2399832001, "lat": 52.7417244, "lon": 15.5577034}, {"type": "node", "id": 2399832003, "lat": 52.7417197, "lon": 15.5577723}, {"type": "node", "id": 2399832005, "lat": 52.7417604, "lon": 15.5573449}, {"type": "node", "id": 2399832007, "lat": 52.7417962, "lon": 15.5576997}, {"type": "node", "id": 2399832009, "lat": 52.7417939, "lon": 15.5577223}, {"type": "node", "id": 2399832011, "lat": 52.7418145, "lon": 15.5577962}, {"type": "node", "id": 2399832013, "lat": 52.7418299, "lon": 15.5573632}, {"type": "node", "id": 2399832015, "lat": 52.7418233, "lon": 15.557428}, {"type": "node", "id": 2399832017, "lat": 52.7418229, "lon": 15.5577126}, {"type": "node", "id": 2399832023, "lat": 52.7419256, "lon": 15.5574543}, {"type": "node", "id": 2399832029, "lat": 52.7419322, "lon": 15.5573903}, {"type": "node", "id": 2399832031, "lat": 52.7419402, "lon": 15.5577138}, {"type": "node", "id": 2399832037, "lat": 52.7419618, "lon": 15.5575155}, {"type": "node", "id": 2399832047, "lat": 52.7420132, "lon": 15.5575301}, {"type": "node", "id": 2399832049, "lat": 52.7419914, "lon": 15.5577284}, {"type": "node", "id": 2399832248, "lat": 52.7489755, "lon": 15.5594452}, {"type": "node", "id": 2399832250, "lat": 52.7489631, "lon": 15.5594837}, {"type": "node", "id": 2399832251, "lat": 52.7489715, "lon": 15.5594741}, {"type": "node", "id": 2399832253, "lat": 52.7489604, "lon": 15.5595089}, {"type": "node", "id": 2399832255, "lat": 52.748966, "lon": 15.559523}, {"type": "node", "id": 2399832257, "lat": 52.7489604, "lon": 15.5595703}, {"type": "node", "id": 2399832259, "lat": 52.7490346, "lon": 15.5594648}, {"type": "node", "id": 2399832261, "lat": 52.7490194, "lon": 15.5595902}, {"type": "node", "id": 2399832263, "lat": 52.7491212, "lon": 15.5597315}, {"type": "node", "id": 2399832265, "lat": 52.7491478, "lon": 15.5595105}, {"type": "node", "id": 2399832268, "lat": 52.7491885, "lon": 15.5597495}, {"type": "node", "id": 2399832269, "lat": 52.7492144, "lon": 15.5595303}, {"type": "node", "id": 2399832272, "lat": 52.7492328, "lon": 15.5595334}, {"type": "node", "id": 2399832274, "lat": 52.7492289, "lon": 15.5595693}, {"type": "node", "id": 2399832276, "lat": 52.7492515, "lon": 15.5593589}, {"type": "node", "id": 2399832278, "lat": 52.7492774, "lon": 15.5595834}, {"type": "node", "id": 2399832280, "lat": 52.7493002, "lon": 15.5593712}, {"type": "node", "id": 2399836241, "lat": 52.7366461, "lon": 15.5357053}, {"type": "node", "id": 2399836242, "lat": 52.7366354, "lon": 15.5358987}, {"type": "node", "id": 2399836243, "lat": 52.7366332, "lon": 15.5359447}, {"type": "node", "id": 2399836244, "lat": 52.7367055, "lon": 15.5359091}, {"type": "node", "id": 2399836245, "lat": 52.736703, "lon": 15.5359552}, {"type": "node", "id": 2399836246, "lat": 52.7366956, "lon": 15.536096}, {"type": "node", "id": 2399836247, "lat": 52.736693, "lon": 15.5361477}, {"type": "node", "id": 2399836248, "lat": 52.7367162, "lon": 15.5357153}, {"type": "node", "id": 2399836249, "lat": 52.73673, "lon": 15.536099}, {"type": "node", "id": 2399836250, "lat": 52.7367275, "lon": 15.5361511}, {"type": "node", "id": 2399836251, "lat": 52.7367905, "lon": 15.5360448}, {"type": "node", "id": 2399836252, "lat": 52.7368005, "lon": 15.532893}, {"type": "node", "id": 2399836253, "lat": 52.7367959, "lon": 15.5329422}, {"type": "node", "id": 2399836254, "lat": 52.7368014, "lon": 15.5356924}, {"type": "node", "id": 2399836255, "lat": 52.736799, "lon": 15.5357576}, {"type": "node", "id": 2399836256, "lat": 52.7367943, "lon": 15.5359176}, {"type": "node", "id": 2399836257, "lat": 52.7368334, "lon": 15.5329012}, {"type": "node", "id": 2399836258, "lat": 52.7368289, "lon": 15.5329504}, {"type": "node", "id": 2399836259, "lat": 52.7368648, "lon": 15.5357009}, {"type": "node", "id": 2399836260, "lat": 52.7368637, "lon": 15.5357633}, {"type": "node", "id": 2399836261, "lat": 52.736859, "lon": 15.5359229}, {"type": "node", "id": 2399836262, "lat": 52.736855, "lon": 15.53605}, {"type": "node", "id": 2399836263, "lat": 52.7368948, "lon": 15.5348975}, {"type": "node", "id": 2399836264, "lat": 52.7368774, "lon": 15.535082}, {"type": "node", "id": 2399836265, "lat": 52.7369523, "lon": 15.5344438}, {"type": "node", "id": 2399836266, "lat": 52.7370022, "lon": 15.5349184}, {"type": "node", "id": 2399836267, "lat": 52.736986, "lon": 15.5351114}, {"type": "node", "id": 2399836268, "lat": 52.7370654, "lon": 15.5332641}, {"type": "node", "id": 2399836269, "lat": 52.7370613, "lon": 15.5344718}, {"type": "node", "id": 2399836270, "lat": 52.737073, "lon": 15.5343504}, {"type": "node", "id": 2399836271, "lat": 52.7371144, "lon": 15.5368222}, {"type": "node", "id": 2399836272, "lat": 52.7371438, "lon": 15.5343702}, {"type": "node", "id": 2399836273, "lat": 52.7371324, "lon": 15.5344916}, {"type": "node", "id": 2399836274, "lat": 52.7371354, "lon": 15.5365582}, {"type": "node", "id": 2399836275, "lat": 52.7371751, "lon": 15.5332933}, {"type": "node", "id": 2399836276, "lat": 52.737188, "lon": 15.5368383}, {"type": "node", "id": 2399836277, "lat": 52.7372096, "lon": 15.5365745}, {"type": "node", "id": 2399836278, "lat": 52.7372435, "lon": 15.533311}, {"type": "node", "id": 2399836279, "lat": 52.7372542, "lon": 15.534399}, {"type": "node", "id": 2399836280, "lat": 52.7372432, "lon": 15.5345207}, {"type": "node", "id": 2399836281, "lat": 52.7373136, "lon": 15.5345393}, {"type": "node", "id": 2399836282, "lat": 52.7373246, "lon": 15.5344154}, {"type": "node", "id": 2399836283, "lat": 52.7373546, "lon": 15.5333405}, {"type": "node", "id": 2399836284, "lat": 52.7376398, "lon": 15.5350638}, {"type": "node", "id": 2399836285, "lat": 52.7376236, "lon": 15.535257}, {"type": "node", "id": 2399836286, "lat": 52.7374246, "lon": 15.5333591}, {"type": "node", "id": 2399836287, "lat": 52.7374234, "lon": 15.5345698}, {"type": "node", "id": 2399836288, "lat": 52.7374346, "lon": 15.5344448}, {"type": "node", "id": 2399836289, "lat": 52.7375351, "lon": 15.5333882}, {"type": "node", "id": 2399836290, "lat": 52.7375299, "lon": 15.5344685}, {"type": "node", "id": 2399836291, "lat": 52.7375186, "lon": 15.5345947}, {"type": "node", "id": 2399836292, "lat": 52.7376304, "lon": 15.5334131}, {"type": "node", "id": 2399836293, "lat": 52.7376474, "lon": 15.5344287}, {"type": "node", "id": 2399836294, "lat": 52.7376292, "lon": 15.5346246}, {"type": "node", "id": 2399836295, "lat": 52.7376991, "lon": 15.5344434}, {"type": "node", "id": 2399836296, "lat": 52.7376815, "lon": 15.5346381}, {"type": "node", "id": 2399836297, "lat": 52.7377405, "lon": 15.5334422}, {"type": "node", "id": 2399836298, "lat": 52.7377798, "lon": 15.5365239}, {"type": "node", "id": 2399836299, "lat": 52.7377941, "lon": 15.5364114}, {"type": "node", "id": 2399836300, "lat": 52.7379007, "lon": 15.5364469}, {"type": "node", "id": 2399836301, "lat": 52.7378863, "lon": 15.53656}, {"type": "node", "id": 2399836302, "lat": 52.737981, "lon": 15.5363921}, {"type": "node", "id": 2399836303, "lat": 52.7379728, "lon": 15.53646}, {"type": "node", "id": 2399836304, "lat": 52.7380064, "lon": 15.5337056}, {"type": "node", "id": 2399836305, "lat": 52.7380027, "lon": 15.5337962}, {"type": "node", "id": 2399836306, "lat": 52.7380375, "lon": 15.5364141}, {"type": "node", "id": 2399836307, "lat": 52.7380284, "lon": 15.5364836}, {"type": "node", "id": 2399836308, "lat": 52.7380796, "lon": 15.5337176}, {"type": "node", "id": 2399836309, "lat": 52.7380753, "lon": 15.5338095}, {"type": "node", "id": 2399836310, "lat": 52.7381431, "lon": 15.5338319}, {"type": "node", "id": 2399836311, "lat": 52.7381253, "lon": 15.5340839}, {"type": "node", "id": 2399836312, "lat": 52.7381972, "lon": 15.5340976}, {"type": "node", "id": 2399836313, "lat": 52.738215, "lon": 15.5338457}, {"type": "node", "id": 2399836314, "lat": 52.7397678, "lon": 15.5357553}, {"type": "node", "id": 2399836315, "lat": 52.739798, "lon": 15.5355651}, {"type": "node", "id": 2399836316, "lat": 52.7398242, "lon": 15.5357795}, {"type": "node", "id": 2399836317, "lat": 52.7398543, "lon": 15.5355893}, {"type": "node", "id": 2399836318, "lat": 52.7398976, "lon": 15.5355306}, {"type": "node", "id": 2399836319, "lat": 52.7399077, "lon": 15.5354722}, {"type": "node", "id": 2399836320, "lat": 52.7399847, "lon": 15.5356902}, {"type": "node", "id": 2399836321, "lat": 52.7399767, "lon": 15.5357325}, {"type": "node", "id": 2399836322, "lat": 52.7400073, "lon": 15.5354563}, {"type": "node", "id": 2399836323, "lat": 52.7399977, "lon": 15.5355118}, {"type": "node", "id": 2399836324, "lat": 52.7399888, "lon": 15.5355683}, {"type": "node", "id": 2399836325, "lat": 52.7400065, "lon": 15.5357013}, {"type": "node", "id": 2399836326, "lat": 52.7399986, "lon": 15.5357437}, {"type": "node", "id": 2399836327, "lat": 52.7399875, "lon": 15.5358028}, {"type": "node", "id": 2399836328, "lat": 52.7400172, "lon": 15.5356445}, {"type": "node", "id": 2399836329, "lat": 52.7400603, "lon": 15.5356026}, {"type": "node", "id": 2399836330, "lat": 52.740046, "lon": 15.5358312}, {"type": "node", "id": 2399836331, "lat": 52.7400795, "lon": 15.5354937}, {"type": "node", "id": 2399836332, "lat": 52.7400926, "lon": 15.5356106}, {"type": "node", "id": 2399836333, "lat": 52.7400742, "lon": 15.5356742}, {"type": "node", "id": 2399836334, "lat": 52.7401186, "lon": 15.5355315}, {"type": "node", "id": 2399836335, "lat": 52.7401261, "lon": 15.5356504}, {"type": "node", "id": 2399836336, "lat": 52.7401542, "lon": 15.535567}, {"type": "node", "id": 2399836337, "lat": 52.7402595, "lon": 15.5385925}, {"type": "node", "id": 2399836338, "lat": 52.7402866, "lon": 15.538261}, {"type": "node", "id": 2399836339, "lat": 52.7402672, "lon": 15.5384997}, {"type": "node", "id": 2399836340, "lat": 52.7402917, "lon": 15.5382025}, {"type": "node", "id": 2399836341, "lat": 52.7403181, "lon": 15.5382087}, {"type": "node", "id": 2399836342, "lat": 52.7403128, "lon": 15.5382669}, {"type": "node", "id": 2399836343, "lat": 52.7403081, "lon": 15.538322}, {"type": "node", "id": 2399836344, "lat": 52.7403161, "lon": 15.5385122}, {"type": "node", "id": 2399836345, "lat": 52.7403073, "lon": 15.5386061}, {"type": "node", "id": 2399836346, "lat": 52.7403237, "lon": 15.5381453}, {"type": "node", "id": 2399836347, "lat": 52.7403727, "lon": 15.5384069}, {"type": "node", "id": 2399836348, "lat": 52.7403615, "lon": 15.5385287}, {"type": "node", "id": 2399836349, "lat": 52.740394, "lon": 15.5381621}, {"type": "node", "id": 2399836350, "lat": 52.7403785, "lon": 15.5383391}, {"type": "node", "id": 2399836351, "lat": 52.740423, "lon": 15.5384184}, {"type": "node", "id": 2399836352, "lat": 52.7404117, "lon": 15.5385413}, {"type": "node", "id": 2399836353, "lat": 52.7433453, "lon": 15.5380046}, {"type": "node", "id": 2399836354, "lat": 52.7433686, "lon": 15.5378313}, {"type": "node", "id": 2399836355, "lat": 52.7433629, "lon": 15.5378755}, {"type": "node", "id": 2399836356, "lat": 52.7433921, "lon": 15.5378412}, {"type": "node", "id": 2399836357, "lat": 52.7433856, "lon": 15.537885}, {"type": "node", "id": 2399836358, "lat": 52.7434624, "lon": 15.5376022}, {"type": "node", "id": 2399836359, "lat": 52.7434688, "lon": 15.5380504}, {"type": "node", "id": 2399836360, "lat": 52.7434915, "lon": 15.53738}, {"type": "node", "id": 2399836361, "lat": 52.7434865, "lon": 15.5379213}, {"type": "node", "id": 2399836362, "lat": 52.7435414, "lon": 15.5376303}, {"type": "node", "id": 2399836363, "lat": 52.7435232, "lon": 15.5378889}, {"type": "node", "id": 2399836364, "lat": 52.7435349, "lon": 15.5379212}, {"type": "node", "id": 2399836365, "lat": 52.7435166, "lon": 15.5380715}, {"type": "node", "id": 2399836366, "lat": 52.7435459, "lon": 15.5376998}, {"type": "node", "id": 2399836367, "lat": 52.743555, "lon": 15.5378988}, {"type": "node", "id": 2399836368, "lat": 52.7435515, "lon": 15.5379268}, {"type": "node", "id": 2399836369, "lat": 52.7435528, "lon": 15.5380835}, {"type": "node", "id": 2399836370, "lat": 52.7435704, "lon": 15.5374086}, {"type": "node", "id": 2399836371, "lat": 52.7435953, "lon": 15.5377162}, {"type": "node", "id": 2399836372, "lat": 52.7435745, "lon": 15.5379058}, {"type": "node", "id": 2399836373, "lat": 52.7435711, "lon": 15.5379331}, {"type": "node", "id": 2399836374, "lat": 52.7483744, "lon": 15.538616}, {"type": "node", "id": 2399836375, "lat": 52.7483637, "lon": 15.5387331}, {"type": "node", "id": 2399836376, "lat": 52.748499, "lon": 15.5386471}, {"type": "node", "id": 2399836377, "lat": 52.7484882, "lon": 15.5387643}, {"type": "node", "id": 2399836378, "lat": 52.7485067, "lon": 15.5390039}, {"type": "node", "id": 2399836379, "lat": 52.7485257, "lon": 15.5387939}, {"type": "node", "id": 2399836380, "lat": 52.7485595, "lon": 15.5390168}, {"type": "node", "id": 2399836381, "lat": 52.7485785, "lon": 15.5388069}, {"type": "node", "id": 10154564705, "lat": 52.7433738, "lon": 15.5375057}, {"type": "node", "id": 10154564706, "lat": 52.7432903, "lon": 15.5374751}, {"type": "node", "id": 10154564747, "lat": 52.7432441, "lon": 15.5378163}, {"type": "node", "id": 10154564748, "lat": 52.7432362, "lon": 15.5378754}, {"type": "node", "id": 10154564749, "lat": 52.7433207, "lon": 15.5378991}, {"type": "node", "id": 10154564750, "lat": 52.743328, "lon": 15.5378453}, {"type": "node", "id": 2399831830, "lat": 52.7385654, "lon": 15.5566473}, {"type": "node", "id": 2399831832, "lat": 52.7385467, "lon": 15.5568937}, {"type": "node", "id": 2399831845, "lat": 52.7386226, "lon": 15.556909}, {"type": "node", "id": 2399831851, "lat": 52.7386416, "lon": 15.5566653}, {"type": "node", "id": 2399831853, "lat": 52.738647, "lon": 15.5570296}, {"type": "node", "id": 2399831855, "lat": 52.7386339, "lon": 15.5571483}, {"type": "node", "id": 2399831874, "lat": 52.738786, "lon": 15.5570605}, {"type": "node", "id": 2399831876, "lat": 52.7387765, "lon": 15.5571792}, {"type": "node", "id": 2399831892, "lat": 52.738818, "lon": 15.5569446}, {"type": "node", "id": 2399831895, "lat": 52.7388092, "lon": 15.5570533}, {"type": "node", "id": 2399831903, "lat": 52.7388236, "lon": 15.5568756}, {"type": "node", "id": 2399831909, "lat": 52.7388726, "lon": 15.5568853}, {"type": "node", "id": 2399831911, "lat": 52.7388583, "lon": 15.5570644}, {"type": "node", "id": 2399831985, "lat": 52.7413182, "lon": 15.5577527}, {"type": "node", "id": 2399831987, "lat": 52.7413354, "lon": 15.55753}, {"type": "node", "id": 2399831989, "lat": 52.7413694, "lon": 15.5577638}, {"type": "node", "id": 2399831991, "lat": 52.7413861, "lon": 15.5575418}, {"type": "node", "id": 2399831993, "lat": 52.7414746, "lon": 15.557593}, {"type": "node", "id": 2399831995, "lat": 52.7414616, "lon": 15.5577848}, {"type": "node", "id": 2399831997, "lat": 52.7415344, "lon": 15.5576045}, {"type": "node", "id": 2399831999, "lat": 52.7415217, "lon": 15.5577963}, {"type": "node", "id": 2399832001, "lat": 52.7417244, "lon": 15.5577034}, {"type": "node", "id": 2399832003, "lat": 52.7417197, "lon": 15.5577723}, {"type": "node", "id": 2399832005, "lat": 52.7417604, "lon": 15.5573449}, {"type": "node", "id": 2399832007, "lat": 52.7417962, "lon": 15.5576997}, {"type": "node", "id": 2399832009, "lat": 52.7417939, "lon": 15.5577223}, {"type": "node", "id": 2399832011, "lat": 52.7418145, "lon": 15.5577962}, {"type": "node", "id": 2399832013, "lat": 52.7418299, "lon": 15.5573632}, {"type": "node", "id": 2399832015, "lat": 52.7418233, "lon": 15.557428}, {"type": "node", "id": 2399832017, "lat": 52.7418229, "lon": 15.5577126}, {"type": "node", "id": 2399832023, "lat": 52.7419256, "lon": 15.5574543}, {"type": "node", "id": 2399832029, "lat": 52.7419322, "lon": 15.5573903}, {"type": "node", "id": 2399832031, "lat": 52.7419402, "lon": 15.5577138}, {"type": "node", "id": 2399832037, "lat": 52.7419618, "lon": 15.5575155}, {"type": "node", "id": 2399832047, "lat": 52.7420132, "lon": 15.5575301}, {"type": "node", "id": 2399832049, "lat": 52.7419914, "lon": 15.5577284}, {"type": "node", "id": 2399832248, "lat": 52.7489755, "lon": 15.5594452}, {"type": "node", "id": 2399832250, "lat": 52.7489631, "lon": 15.5594837}, {"type": "node", "id": 2399832251, "lat": 52.7489715, "lon": 15.5594741}, {"type": "node", "id": 2399832253, "lat": 52.7489604, "lon": 15.5595089}, {"type": "node", "id": 2399832255, "lat": 52.748966, "lon": 15.559523}, {"type": "node", "id": 2399832257, "lat": 52.7489604, "lon": 15.5595703}, {"type": "node", "id": 2399832259, "lat": 52.7490346, "lon": 15.5594648}, {"type": "node", "id": 2399832261, "lat": 52.7490194, "lon": 15.5595902}, {"type": "node", "id": 2399832263, "lat": 52.7491212, "lon": 15.5597315}, {"type": "node", "id": 2399832265, "lat": 52.7491478, "lon": 15.5595105}, {"type": "node", "id": 2399832268, "lat": 52.7491885, "lon": 15.5597495}, {"type": "node", "id": 2399832269, "lat": 52.7492144, "lon": 15.5595303}, {"type": "node", "id": 2399832272, "lat": 52.7492328, "lon": 15.5595334}, {"type": "node", "id": 2399832274, "lat": 52.7492289, "lon": 15.5595693}, {"type": "node", "id": 2399832276, "lat": 52.7492515, "lon": 15.5593589}, {"type": "node", "id": 2399832278, "lat": 52.7492774, "lon": 15.5595834}, {"type": "node", "id": 2399832280, "lat": 52.7493002, "lon": 15.5593712}, {"type": "node", "id": 2399836241, "lat": 52.7366461, "lon": 15.5357053}, {"type": "node", "id": 2399836242, "lat": 52.7366354, "lon": 15.5358987}, {"type": "node", "id": 2399836243, "lat": 52.7366332, "lon": 15.5359447}, {"type": "node", "id": 2399836244, "lat": 52.7367055, "lon": 15.5359091}, {"type": "node", "id": 2399836245, "lat": 52.736703, "lon": 15.5359552}, {"type": "node", "id": 2399836246, "lat": 52.7366956, "lon": 15.536096}, {"type": "node", "id": 2399836247, "lat": 52.736693, "lon": 15.5361477}, {"type": "node", "id": 2399836248, "lat": 52.7367162, "lon": 15.5357153}, {"type": "node", "id": 2399836249, "lat": 52.73673, "lon": 15.536099}, {"type": "node", "id": 2399836250, "lat": 52.7367275, "lon": 15.5361511}, {"type": "node", "id": 2399836251, "lat": 52.7367905, "lon": 15.5360448}, {"type": "node", "id": 2399836252, "lat": 52.7368005, "lon": 15.532893}, {"type": "node", "id": 2399836253, "lat": 52.7367959, "lon": 15.5329422}, {"type": "node", "id": 2399836254, "lat": 52.7368014, "lon": 15.5356924}, {"type": "node", "id": 2399836255, "lat": 52.736799, "lon": 15.5357576}, {"type": "node", "id": 2399836256, "lat": 52.7367943, "lon": 15.5359176}, {"type": "node", "id": 2399836257, "lat": 52.7368334, "lon": 15.5329012}, {"type": "node", "id": 2399836258, "lat": 52.7368289, "lon": 15.5329504}, {"type": "node", "id": 2399836259, "lat": 52.7368648, "lon": 15.5357009}, {"type": "node", "id": 2399836260, "lat": 52.7368637, "lon": 15.5357633}, {"type": "node", "id": 2399836261, "lat": 52.736859, "lon": 15.5359229}, {"type": "node", "id": 2399836262, "lat": 52.736855, "lon": 15.53605}, {"type": "node", "id": 2399836263, "lat": 52.7368948, "lon": 15.5348975}, {"type": "node", "id": 2399836264, "lat": 52.7368774, "lon": 15.535082}, {"type": "node", "id": 2399836265, "lat": 52.7369523, "lon": 15.5344438}, {"type": "node", "id": 2399836266, "lat": 52.7370022, "lon": 15.5349184}, {"type": "node", "id": 2399836267, "lat": 52.736986, "lon": 15.5351114}, {"type": "node", "id": 2399836268, "lat": 52.7370654, "lon": 15.5332641}, {"type": "node", "id": 2399836269, "lat": 52.7370613, "lon": 15.5344718}, {"type": "node", "id": 2399836270, "lat": 52.737073, "lon": 15.5343504}, {"type": "node", "id": 2399836271, "lat": 52.7371144, "lon": 15.5368222}, {"type": "node", "id": 2399836272, "lat": 52.7371438, "lon": 15.5343702}, {"type": "node", "id": 2399836273, "lat": 52.7371324, "lon": 15.5344916}, {"type": "node", "id": 2399836274, "lat": 52.7371354, "lon": 15.5365582}, {"type": "node", "id": 2399836275, "lat": 52.7371751, "lon": 15.5332933}, {"type": "node", "id": 2399836276, "lat": 52.737188, "lon": 15.5368383}, {"type": "node", "id": 2399836277, "lat": 52.7372096, "lon": 15.5365745}, {"type": "node", "id": 2399836278, "lat": 52.7372435, "lon": 15.533311}, {"type": "node", "id": 2399836279, "lat": 52.7372542, "lon": 15.534399}, {"type": "node", "id": 2399836280, "lat": 52.7372432, "lon": 15.5345207}, {"type": "node", "id": 2399836281, "lat": 52.7373136, "lon": 15.5345393}, {"type": "node", "id": 2399836282, "lat": 52.7373246, "lon": 15.5344154}, {"type": "node", "id": 2399836283, "lat": 52.7373546, "lon": 15.5333405}, {"type": "node", "id": 2399836284, "lat": 52.7376398, "lon": 15.5350638}, {"type": "node", "id": 2399836285, "lat": 52.7376236, "lon": 15.535257}, {"type": "node", "id": 2399836286, "lat": 52.7374246, "lon": 15.5333591}, {"type": "node", "id": 2399836287, "lat": 52.7374234, "lon": 15.5345698}, {"type": "node", "id": 2399836288, "lat": 52.7374346, "lon": 15.5344448}, {"type": "node", "id": 2399836289, "lat": 52.7375351, "lon": 15.5333882}, {"type": "node", "id": 2399836290, "lat": 52.7375299, "lon": 15.5344685}, {"type": "node", "id": 2399836291, "lat": 52.7375186, "lon": 15.5345947}, {"type": "node", "id": 2399836292, "lat": 52.7376304, "lon": 15.5334131}, {"type": "node", "id": 2399836293, "lat": 52.7376474, "lon": 15.5344287}, {"type": "node", "id": 2399836294, "lat": 52.7376292, "lon": 15.5346246}, {"type": "node", "id": 2399836295, "lat": 52.7376991, "lon": 15.5344434}, {"type": "node", "id": 2399836296, "lat": 52.7376815, "lon": 15.5346381}, {"type": "node", "id": 2399836297, "lat": 52.7377405, "lon": 15.5334422}, {"type": "node", "id": 2399836298, "lat": 52.7377798, "lon": 15.5365239}, {"type": "node", "id": 2399836299, "lat": 52.7377941, "lon": 15.5364114}, {"type": "node", "id": 2399836300, "lat": 52.7379007, "lon": 15.5364469}, {"type": "node", "id": 2399836301, "lat": 52.7378863, "lon": 15.53656}, {"type": "node", "id": 2399836302, "lat": 52.737981, "lon": 15.5363921}, {"type": "node", "id": 2399836303, "lat": 52.7379728, "lon": 15.53646}, {"type": "node", "id": 2399836304, "lat": 52.7380064, "lon": 15.5337056}, {"type": "node", "id": 2399836305, "lat": 52.7380027, "lon": 15.5337962}, {"type": "node", "id": 2399836306, "lat": 52.7380375, "lon": 15.5364141}, {"type": "node", "id": 2399836307, "lat": 52.7380284, "lon": 15.5364836}, {"type": "node", "id": 2399836308, "lat": 52.7380796, "lon": 15.5337176}, {"type": "node", "id": 2399836309, "lat": 52.7380753, "lon": 15.5338095}, {"type": "node", "id": 2399836310, "lat": 52.7381431, "lon": 15.5338319}, {"type": "node", "id": 2399836311, "lat": 52.7381253, "lon": 15.5340839}, {"type": "node", "id": 2399836312, "lat": 52.7381972, "lon": 15.5340976}, {"type": "node", "id": 2399836313, "lat": 52.738215, "lon": 15.5338457}, {"type": "node", "id": 2399836314, "lat": 52.7397678, "lon": 15.5357553}, {"type": "node", "id": 2399836315, "lat": 52.739798, "lon": 15.5355651}, {"type": "node", "id": 2399836316, "lat": 52.7398242, "lon": 15.5357795}, {"type": "node", "id": 2399836317, "lat": 52.7398543, "lon": 15.5355893}, {"type": "node", "id": 2399836318, "lat": 52.7398976, "lon": 15.5355306}, {"type": "node", "id": 2399836319, "lat": 52.7399077, "lon": 15.5354722}, {"type": "node", "id": 2399836320, "lat": 52.7399847, "lon": 15.5356902}, {"type": "node", "id": 2399836321, "lat": 52.7399767, "lon": 15.5357325}, {"type": "node", "id": 2399836322, "lat": 52.7400073, "lon": 15.5354563}, {"type": "node", "id": 2399836323, "lat": 52.7399977, "lon": 15.5355118}, {"type": "node", "id": 2399836324, "lat": 52.7399888, "lon": 15.5355683}, {"type": "node", "id": 2399836325, "lat": 52.7400065, "lon": 15.5357013}, {"type": "node", "id": 2399836326, "lat": 52.7399986, "lon": 15.5357437}, {"type": "node", "id": 2399836327, "lat": 52.7399875, "lon": 15.5358028}, {"type": "node", "id": 2399836328, "lat": 52.7400172, "lon": 15.5356445}, {"type": "node", "id": 2399836329, "lat": 52.7400603, "lon": 15.5356026}, {"type": "node", "id": 2399836330, "lat": 52.740046, "lon": 15.5358312}, {"type": "node", "id": 2399836331, "lat": 52.7400795, "lon": 15.5354937}, {"type": "node", "id": 2399836332, "lat": 52.7400926, "lon": 15.5356106}, {"type": "node", "id": 2399836333, "lat": 52.7400742, "lon": 15.5356742}, {"type": "node", "id": 2399836334, "lat": 52.7401186, "lon": 15.5355315}, {"type": "node", "id": 2399836335, "lat": 52.7401261, "lon": 15.5356504}, {"type": "node", "id": 2399836336, "lat": 52.7401542, "lon": 15.535567}, {"type": "node", "id": 2399836337, "lat": 52.7402595, "lon": 15.5385925}, {"type": "node", "id": 2399836338, "lat": 52.7402866, "lon": 15.538261}, {"type": "node", "id": 2399836339, "lat": 52.7402672, "lon": 15.5384997}, {"type": "node", "id": 2399836340, "lat": 52.7402917, "lon": 15.5382025}, {"type": "node", "id": 2399836341, "lat": 52.7403181, "lon": 15.5382087}, {"type": "node", "id": 2399836342, "lat": 52.7403128, "lon": 15.5382669}, {"type": "node", "id": 2399836343, "lat": 52.7403081, "lon": 15.538322}, {"type": "node", "id": 2399836344, "lat": 52.7403161, "lon": 15.5385122}, {"type": "node", "id": 2399836345, "lat": 52.7403073, "lon": 15.5386061}, {"type": "node", "id": 2399836346, "lat": 52.7403237, "lon": 15.5381453}, {"type": "node", "id": 2399836347, "lat": 52.7403727, "lon": 15.5384069}, {"type": "node", "id": 2399836348, "lat": 52.7403615, "lon": 15.5385287}, {"type": "node", "id": 2399836349, "lat": 52.740394, "lon": 15.5381621}, {"type": "node", "id": 2399836350, "lat": 52.7403785, "lon": 15.5383391}, {"type": "node", "id": 2399836351, "lat": 52.740423, "lon": 15.5384184}, {"type": "node", "id": 2399836352, "lat": 52.7404117, "lon": 15.5385413}, {"type": "node", "id": 2399836353, "lat": 52.7433453, "lon": 15.5380046}, {"type": "node", "id": 2399836354, "lat": 52.7433686, "lon": 15.5378313}, {"type": "node", "id": 2399836355, "lat": 52.7433629, "lon": 15.5378755}, {"type": "node", "id": 2399836356, "lat": 52.7433921, "lon": 15.5378412}, {"type": "node", "id": 2399836357, "lat": 52.7433856, "lon": 15.537885}, {"type": "node", "id": 2399836358, "lat": 52.7434624, "lon": 15.5376022}, {"type": "node", "id": 2399836359, "lat": 52.7434688, "lon": 15.5380504}, {"type": "node", "id": 2399836360, "lat": 52.7434915, "lon": 15.53738}, {"type": "node", "id": 2399836361, "lat": 52.7434865, "lon": 15.5379213}, {"type": "node", "id": 2399836362, "lat": 52.7435414, "lon": 15.5376303}, {"type": "node", "id": 2399836363, "lat": 52.7435232, "lon": 15.5378889}, {"type": "node", "id": 2399836364, "lat": 52.7435349, "lon": 15.5379212}, {"type": "node", "id": 2399836365, "lat": 52.7435166, "lon": 15.5380715}, {"type": "node", "id": 2399836366, "lat": 52.7435459, "lon": 15.5376998}, {"type": "node", "id": 2399836367, "lat": 52.743555, "lon": 15.5378988}, {"type": "node", "id": 2399836368, "lat": 52.7435515, "lon": 15.5379268}, {"type": "node", "id": 2399836369, "lat": 52.7435528, "lon": 15.5380835}, {"type": "node", "id": 2399836370, "lat": 52.7435704, "lon": 15.5374086}, {"type": "node", "id": 2399836371, "lat": 52.7435953, "lon": 15.5377162}, {"type": "node", "id": 2399836372, "lat": 52.7435745, "lon": 15.5379058}, {"type": "node", "id": 2399836373, "lat": 52.7435711, "lon": 15.5379331}, {"type": "node", "id": 2399836374, "lat": 52.7483744, "lon": 15.538616}, {"type": "node", "id": 2399836375, "lat": 52.7483637, "lon": 15.5387331}, {"type": "node", "id": 2399836376, "lat": 52.748499, "lon": 15.5386471}, {"type": "node", "id": 2399836377, "lat": 52.7484882, "lon": 15.5387643}, {"type": "node", "id": 2399836378, "lat": 52.7485067, "lon": 15.5390039}, {"type": "node", "id": 2399836379, "lat": 52.7485257, "lon": 15.5387939}, {"type": "node", "id": 2399836380, "lat": 52.7485595, "lon": 15.5390168}, {"type": "node", "id": 2399836381, "lat": 52.7485785, "lon": 15.5388069}, {"type": "node", "id": 10154564705, "lat": 52.7433738, "lon": 15.5375057}, {"type": "node", "id": 10154564706, "lat": 52.7432903, "lon": 15.5374751}, {"type": "node", "id": 10154564747, "lat": 52.7432441, "lon": 15.5378163}, {"type": "node", "id": 10154564748, "lat": 52.7432362, "lon": 15.5378754}, {"type": "node", "id": 10154564749, "lat": 52.7433207, "lon": 15.5378991}, {"type": "node", "id": 10154564750, "lat": 52.743328, "lon": 15.5378453}]}
    # name, nodes, geometry
    # create a dataframe just with name and nodes
    buildings = []
    if 'elements' not in r:
        raise Exception("No elements in response")
    for building in r['elements']:
        if 'tags' in building and 'building' in building['tags'] and 'nodes' in building:
            buildings.append({"name": building['tags']['building'], "nodes": building['nodes']})
    # create a dict {node_id: (lat, lon)}
    node_to_latlon = {}
    for node in r['elements']:
        if 'type' in node and node['type'] == 'node' and 'id' in node and 'lat' in node and 'lon' in node:
            node_to_latlon[node['id']] = (node['lat'], node['lon'])
    # create the dataframe
    buildings_df = pd.DataFrame(data=buildings)
    # create a column with lat and lon
    for i, row in buildings_df.iterrows():
        latlons = []
        for node_id in row['nodes']:
            latlons.append(node_to_latlon[node_id])
        buildings_df.at[i, 'geometry'] = shapely.geometry.Polygon(latlons)
    # drop the nodes column
    buildings_df = buildings_df.drop(columns=['nodes'])
    # create a GeoDataFrame
    buildings_gdf = gpd.GeoDataFrame(buildings_df, geometry='geometry', crs='EPSG:4326')
    return buildings_gdf

def get_feature_gpd(area_name: str, api: overpass.API, date: str = None) -> gpd.GeoDataFrame:
    """Get feature data from Overpass API in the form of a GeoDataFrame:

    Feature name, Geometry

    Keyword arguments:

    area_name -- name of the area to get data from
    api -- overpass API object
    date -- date of the data (default None)
    """
    
    node_names = ['amenity', 'building', 'highway', 'public_transport', 'government', 'leisure', 'office', 'natural']
    amenities = get_point_data(node_names[0], area_name, api)
    highways = get_point_data(node_names[2], area_name, api)
    public_transport = get_point_data(node_names[3], area_name, api)
    government = get_point_data(node_names[4], area_name, api)
    leisure = get_point_data(node_names[5], area_name, api)
    office = get_point_data(node_names[6], area_name, api)

    amenities.extend(highways)
    amenities.extend(leisure)
    amenities.extend(office)
    amenities.extend(government)
    amenities.extend(public_transport)
    features_gdf = gpd.GeoDataFrame(data=[{'name': amen['type']} for amen in amenities], geometry=[amen['geometry'] for amen in amenities], crs='EPSG:4326')
    return features_gdf

def get_area_gdf(building_gdf: pd.DataFrame, hexagon_res: int = 9) -> pd.DataFrame:
    """Calculate area of buildings for hexagon grid, return a GeoDataFrame:

    Feature 1 name, Feature 2 name,
    Feature 1 area in m^2, Feature 2 area in m^2,

    Indexed by hexagon id.

    Keyword arguments:

    building_gdf -- GeoDataFrame with building data
    hexagon_res -- resolution of the hexagon grid (default 9)
    """
    inproj = pyproj.Proj('EPSG:4326')
    outproj = pyproj.Proj('EPSG:3857')
    transformer = pyproj.Transformer.from_proj(inproj, outproj)
    # get hexagons which intersect with buildings
    # columns are unique building names
    # rows are hexagon ids
    retv = pd.DataFrame(columns=['hex_id', 'name', 'area'])
    for _, row in building_gdf.iterrows():
        latlons = [(lat, lon) for lat, lon in row['geometry'].exterior.coords]
        # delete last point if it is the same as the first one
        if len(latlons) > 1 and latlons[0] == latlons[-1]:
            latlons.pop()
        # convert to h3 polygon
        p = h3.Polygon(latlons)
        hexagons = h3.polygon_to_cells(p, hexagon_res)
        # this only returns cells fully contained in the polygon
        # add cells on the border
        for lat, lon in latlons:
            hexagons.add(h3.latlng_to_cell(lat, lon, hexagon_res))
        # make the list unique
        hexagons = set(hexagons)
        # calculate area of intersection
        for hexagon in hexagons:
            # calculate intersection using shapely
            bdry = shapely.geometry.Polygon(h3.cell_to_boundary(hexagon, False))
            row_xy = shapely.geometry.Polygon(row['geometry'])
            # convert to xy coordinates using pyproj
            bdry = shapely.ops.transform(transformer.transform, bdry)
            row_xy = shapely.ops.transform(transformer.transform, row_xy)
            # convert to shapely polygon
            bdry = shapely.geometry.Polygon(bdry)
            inter_area = bdry.intersection(row_xy).area
            # inter_area = row['geometry'].intersection(shapely.geometry.Polygon(h3.cell_to_boundary(hexagon, True))).area
            # add to dataframe
            dict_to_add = {'hex_id': hexagon, 'name': row['name'], 'area': inter_area}
            new_index = len(retv)
            retv.loc[new_index] = dict_to_add
    retv = retv.groupby(['hex_id', 'name']).sum()
    retv = retv.reset_index()
    # pivot the table
    retv = retv.pivot(index='hex_id', columns='name', values='area')
    # fill NaNs with 0
    retv = retv.fillna(0)
    return retv

def get_all_data(area_name: str, api: overpass.API, hexagon_res: int = 9) -> pd.DataFrame:
    """Get all data from Overpass API in the form of a DataFrame:

    Feature 1 name, Feature 2 name,
    Feature 1 area in m^2, Feature 2 area in m^2,

    Indexed by hexagon id.

    Keyword arguments:

    area_name -- name of the area to get data from
    api -- overpass API object
    hexagon_res -- resolution of the hexagon grid (default 9)
    """
    building_gdf = get_building_data(area_name, api)
    area_gdf = get_area_gdf(building_gdf, hexagon_res)
    feature_gdf = get_feature_gpd(area_name, api)
    # merge the two
    retv = pd.merge(area_gdf, feature_gdf, how='outer', left_index=True, right_index=True)
    # fill NaNs with 0
    retv = retv.fillna(0)
    return retv

if __name__ == "__main__":
    # test get_building_data
    # print("Testing get_building_data")
    api = overpass.API()
    # a = get_building_data("Mkoszyce", api)
    # print(a)
    # test get_area_gdf
    # print("Testing get_area_gdf")
    # b = get_area_gdf(a)
    # print(b)
    # print b where manufacture is > 0
    # print(b[b['manufacture'] > 0])
    # test get_all_data
    # print("Testing get_all_data")
    b = get_all_data("Mkoszyce", api)
    print(b)
    # test get_feature_gpd
    # print("Testing get_feature_gpd")
    # b = get_feature_gpd("Posk", api)
    # print(b)
